<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: helpers/smoke/Smoke.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: helpers/smoke/Smoke.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { runCLI } = require('jest');
const path = require('path');
const fs = require('fs');
const glob = require('glob');
const TestClient = require('./../testClient');
const { error } = require('../logger');
const metricsClient = require('@condor-labs/metrics');

/**
 * @class Smoke
 * @constructor
 * @param {String} datacenter - JAX|BDU
 * @param {String} env - test|demo|production
 * @param {String} group - auth.evercheck.com .....
 * @classdesc Smoke Test class, contain methods: getTestFolderDetails, updateSuiteResultsKeys, updateGroupsByEnvironment and executeTest
 */
class Smoke {
  constructor(datacenter, env, group, workerType) {
    this.env = env;
    this.group = group;
    this.datacenter = datacenter;
    this.workerType = workerType;
  }

  /**
   * @method
   * @async
   * @returns {Object} Object with the folders that contain the tests to be executed
   * @summary This function returns an object with two keys groupTestFolder key and globalTestFolder key
   */
  getTestFolderDetails() {
    let groupTestFolder = this.group.includes('|')
      ? 'scraping.scripts'
      : `scraping.scripts.${this.group}`;

    let globalTestFolder = path.join(__dirname, '..', '..', 'scraping', 'scripts');

    return {
      groupTestFolder,
      globalTestFolder
    };
  }

   /**
   * @method
   * @async
   * @param {Object} formatResult - smoke tests results
   * @returns {Object} - Object with maped smoke tests results
   * @summary This function returns an object with the smoke tests results but replacing http with https
   */
  updateSuiteResultsKeys(formatResult) {
    const { suites } = formatResult;
    for (let key in suites) {
      let suite = suites[key];
      suites[key] = suite;
      suites[key].testSuite = key.replace('http://', '').replace('https://', '');
    }

    return formatResult;
  }

  /**
   * @method
   * @async
   * @param {String} group - group or groups to execute the smoke tests
   * @returns {String} - group
   */
  async updateGroupsByEnvironment(group) {
    const groups = [];
    let groupPath = group.includes('|')
      ? path.resolve(__dirname, '../../scraping/scripts')
      : path.resolve(__dirname, '../../scraping/scripts', group);

    if (!fs.existsSync(groupPath))
      throw new Error('The group does not exist in the path');

    const getConfigsInsideGroup = new Promise((resolve, reject) => {
      try {
        const options = {
          cwd: groupPath
        };
        const forFiles = function (err, files) {
          if (err) reject(err);
          resolve(files);
        };

        glob(`**/*${this.env}.config.js`, options, forFiles);
      } catch (e) {
        reject(e);
      }
    });

    const configFiles = await getConfigsInsideGroup;
    for (const configFile of configFiles) {
      let configFilePath = path.resolve(groupPath, configFile);
      const {
        config: { url }
      } = require(configFilePath);
      groups.push(url.replace('http://', '').replace('https://', ''));
    }

    return groups.length > 1 ? groups.join('|') : groups[0];
  }

  /**
   * @method
   * @async
   * @return smoke tests results
   * @summary This function executes the smoke tests, collects metrics and returns the results
   */
  async executeTest() {
    try {
      let groupUpdated;
      process.env.NODE_ENV = this.env;
      process.env.WORKER_TYPE = this.workerType;
      const { groupTestFolder, globalTestFolder } = this.getTestFolderDetails();
      const jestConfig = {
        _: [`${groupTestFolder}`],
        globals: { globalTest: true },
        runInBand: true,
        passWithNoTests: true,
        noStackTrace: true,
        silent: true,
        reporters: []
      };
      const testClient = new TestClient();
      if (this.env != 'demo') {
        groupUpdated = await this.updateGroupsByEnvironment(this.group);
        if (JSON.parse(process.env.SEND_METRICS) &amp;&amp; groupUpdated)
          await testClient.collectMetricsBegin(this.datacenter, groupUpdated);
      }
      const smokeResults = await runCLI(jestConfig, [globalTestFolder]);
      const formatResult = await testClient.formatResult(smokeResults);
      if (this.env != 'demo') {
        if (JSON.parse(process.env.SEND_METRICS) &amp;&amp; groupUpdated)
          await testClient.collectMetricsEnd(
            this.datacenter,
            this.updateSuiteResultsKeys(formatResult)
          );
      }
      return formatResult;
    } catch (e) {
      error(e);
    }
  }
}

module.exports = Smoke;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-accounts.html">accounts</a></li><li><a href="module-secure%2520-%2520bulkUploads_resolvers.html">secure - bulkUploads/resolvers</a></li><li><a href="module-secure%2520-%2520employee_resolvers.html">secure - employee/resolvers</a></li><li><a href="module-secure%2520-%2520employee_utils.html">secure - employee/utils</a></li><li><a href="module-secure%2520-%2520licenseVerification_resolvers.html">secure - licenseVerification/resolvers</a></li><li><a href="module-secure%2520-%2520positionRequirements_resolvers.html">secure - positionRequirements/resolvers</a></li><li><a href="module-secure%2520-%2520positionRequirements_utils.html">secure - positionRequirements/utils</a></li><li><a href="module-secure%2520-%2520prehire_resolvers.html">secure - prehire/resolvers</a></li><li><a href="module-secure%2520-%2520prehire_utils.html">secure - prehire/utils</a></li><li><a href="module-secure%2520-%2520reports_resolvers.html">secure - reports/resolvers</a></li><li><a href="module-secure%2520-%2520reports_utils.html">secure - reports/utils</a></li><li><a href="module-secure%2520-%2520utils.html">secure - utils</a></li><li><a href="module-utils.html">utils</a></li></ul><h3>Classes</h3><ul><li><a href="Puppeteer.html">Puppeteer</a></li><li><a href="Smoke.html">Smoke</a></li><li><a href="TestClient.html">TestClient</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Fri Sep 11 2020 23:03:05 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
